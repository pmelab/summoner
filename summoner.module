<?php
/**
 * @file
 * Attach JS and CSS assets on demand from javascript using l.js.
 */

/**
 * Implements hook_library().
 */
function summoner_library() {
  $libraries = array();
  $libraries['summoner'] = array(
    'title' => t('Summoner'),
    'website' => 'http://www.drupal.org/project/summoner',
    'version' => '1.0',
    'js' => array(
      drupal_get_path('module', 'summoner') . '/assets/summoner.js' => array(),
    ),
    'dependencies' => array(
      array('system', 'drupal.ajax'),
    ),
  );
  return $libraries;
}

/**
 * Implements hook_menu().
 */
function summoner_menu() {
  $items = array();
  $items['summoner/load/%/%summoner_libraries'] = array(
    'page callback' => 'summoner_load',
    'page arguments' => array(2, 3),
    'load arguments' => array(3),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * Argument autoloader for libraries.
 */
function summoner_libraries_load($libraries) {
  $libraries = explode(',', $libraries);
  foreach ($libraries as $index => $lib) {
    list($module, $name) = explode('::', $lib);
    if (!drupal_get_library($module, $name)) {
      return FALSE;
    }
    $libraries[$index] = array($module, $name);
  }
  return $libraries;
}

/**
 * Build an AJAX response that causes Drupal to load additional required assets.
 */
function summoner_load($id, $libraries) {
  $attached['#attached'] = array('library' => $libraries);
  drupal_render($attached);
  $page = array(
    '#type' => 'ajax',
    '#commands' => array(ajax_command_invoke('body', 'summonerLoaded', array($id))),
  );
  ajax_deliver($page);
}
